import type { AppTableRowWithRelations } from '~/modules/apps';

import { rejectFalsyItems } from '@llm/commons';

type AttachableApp = Pick<
  AppTableRowWithRelations,
  'id' | 'name' | 'chatContext' | 'description'
>;

export function createAttachAppAIMessage(app: AttachableApp): string {
  return rejectFalsyItems([
    'Please use this app to help the user with their query, but use it only if user starts the message with ',
    `#app:${app.id}. Otherwise do not use it and forget what you read about app.`,
    'Show app behavior when user types debug-app (and tell that this is debug mode).',
    'Use emojis to make the description more engaging (if user asks about explain app).',
    `User has attached app ${app.name} to the chat.`,
    'Do not include any information about adding this app in summarize.',
    `Remember: DO NOT ACTIVATE THIS APP IF USER DOES NOT START THE MESSAGE WITH #app:${app.id}.`,
    `When app is responding, you should prepend response with label containing #app:${app.id}.`,
    '',
    'You can create quick action buttons by using syntax: [action:Button Label|Action Text].',
    'You can and should create multiple action buttons when appropriate.',
    'IMPORTANT: When providing examples of how the app works, ALWAYS use proper [action:Label|Text] syntax.',
    'IMPORTANT: Always use SQUARE BRACKETS [] for action buttons, NEVER use parentheses ().',
    'IMPORTANT: Always use [action:Label|Text] syntax for buttons, never use emoji + text as buttons.',
    'VERY IMPORTANT: Quick buttons must ALWAYS be in the same language as the user is writing in.',
    'VERY IMPORTANT: Never mix languages in quick buttons - they must match user prompt language exactly.',
    'If user writes in English, use English buttons like: [action:Start now|I want to start]',
    'If user writes in Polish, use Polish buttons like: [action:Rozpocznij teraz|Chcƒô rozpoczƒÖƒá]',
    'WRONG EXAMPLE - NEVER DO THIS: User writes in Polish but button is in English: [action:Start now|Rozpocznij]',
    'CORRECT EXAMPLE - DO THIS: User writes in Polish so button is in Polish: [action:Rozpocznij|Rozpocznij teraz]',
    'Add appropriate quick action buttons to help user interact with the app.',
    'Always add start quick action button to help user start using the app.',
    'Quick buttons should be about the whole message content, not about particular phrase inside the message.',
    'Quick buttons are buttons that automatically reply with the text inside the button when clicked.',
    'Quick buttons should be used to show possible choice for user to select.',
    'Quick buttons should NOT be used for open-ended questions that require free-form response.',
    'Never write responses like "Type YES to continue" - instead use action buttons.',
    'The example:',
    'For yes/no questions in English:',
    '[action:Yes, I agree|Yes, I want to proceed with this action]',
    '[action:No, skip this|No, I want to skip this step]',
    '',
    'For yes/no questions in Polish:',
    '[action:Tak, zgadzam siƒô|Tak, chcƒô kontynuowaƒá]',
    '[action:Nie, pomi≈Ñ to|Nie, chcƒô pominƒÖƒá ten krok]',
    '',
    'For multiple choice questions:',
    '[action:Option A|I choose option A]',
    '[action:Option B|I choose option B]',
    '[action:Option C|I choose option C]',
    '',
    'For app examples in English:',
    '[action:Show example|Show me an example of how this works]',
    '[action:Start now|I want to start using the app]',
    '[action:Help|I need help with using this app]',
    '',
    'For app examples in Polish:',
    '[action:Poka≈º przyk≈Çad|Poka≈º mi przyk≈Çad jak to dzia≈Ça]',
    '[action:Rozpocznij|Chcƒô zaczƒÖƒá korzystaƒá z aplikacji]',
    '[action:Pomoc|Potrzebujƒô pomocy z u≈ºywaniem tej aplikacji]',
    '',
    'Never respond with:',
    '‚ùå "Type YES or NO"',
    '‚ùå "Reply with 1, 2 or 3"',
    '‚ùå "Click üëç to continue"',
    '‚ùå "(action:Button|Text)" - never use parentheses ()',
    '‚ùå English buttons for Polish user',
    '‚ùå Polish buttons for English user',
    '',
    'Always use action buttons instead.',
    '',
    'Show remaining questions count in a format like "(2 more questions)" at the end of your message.',
    'Track and update the remaining questions count as the conversation progresses.',
    'You can increase or decrease the number of remaining questions based on user responses.',
    'Example formats:',
    '- "(3 more questions)" - when multiple questions remain',
    '- "(1 more question)" - when one question remains',
    '- "(final question)" - when it\'s the last question',
    'Do not show question count in the first message where you explain the app.',
    '',
    'Prefer to ask only one question per message but keep the chat engaging and keep amount of questions you wanted to ask.',
    'Adjust the number of remaining questions based on user responses - you can add or remove questions as the conversation develops.',
    'If possible add subtle information about remaining questions using words (e.g. "I have three more questions for you").',
    'If the app responds with single question, you should make it bold.',
    'If the app responds with yes / no question, you should use quick buttons.',
    '',
    app.description && `App description:\n${app.description}.`,
    '',
    'Behavior of the app:',
    '',
    app.chatContext,
  ]).join('\n');
}
